{% extends "base.html" %}

{% block title %}VPS Settings{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4"><i class="bi bi-gear me-2"></i>VPS Settings</h1>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-server me-2"></i>VPS Connection</h5>
                </div>
                <div class="card-body">
                    <div id="connectionStatus" class="alert alert-secondary mb-3">
                        <i class="bi bi-question-circle me-2"></i>Checking connection...
                    </div>
                    
                    <form id="vpsForm">
                        <div class="mb-3">
                            <label for="vpsHost" class="form-label">VPS Host/IP</label>
                            <input type="text" class="form-control" id="vpsHost" placeholder="e.g., 51.161.131.61">
                        </div>
                        
                        <div class="mb-3">
                            <label for="vpsUser" class="form-label">SSH Username</label>
                            <input type="text" class="form-control" id="vpsUser" placeholder="e.g., root" value="root">
                        </div>
                        
                        <div class="mb-3">
                            <label for="vpsPort" class="form-label">SSH Port</label>
                            <input type="number" class="form-control" id="vpsPort" value="22">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Authentication Method</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="authMethod" id="authPassword" value="password" checked>
                                <label class="form-check-label" for="authPassword">Password</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="authMethod" id="authKey" value="key">
                                <label class="form-check-label" for="authKey">SSH Key</label>
                            </div>
                        </div>
                        
                        <div class="mb-3" id="passwordField">
                            <label for="vpsPassword" class="form-label">SSH Password</label>
                            <input type="password" class="form-control" id="vpsPassword">
                        </div>
                        
                        <div class="mb-3 d-none" id="keyField">
                            <label for="vpsSshKey" class="form-label">SSH Private Key</label>
                            <textarea class="form-control" id="vpsSshKey" rows="5" placeholder="Paste your private key here..."></textarea>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" onclick="testConnection()">
                                <i class="bi bi-plug me-2"></i>Test Connection
                            </button>
                            <button type="button" class="btn btn-success" onclick="saveAndConnect()">
                                <i class="bi bi-check-circle me-2"></i>Save & Connect
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>VPS Information</h5>
                </div>
                <div class="card-body">
                    <div id="vpsInfo">
                        <p class="text-muted">Connect to your VPS to see system information.</p>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-shield-lock me-2"></i>Environment Variables</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small">
                        For production deployments (like Railway), set these environment variables:
                    </p>
                    <ul class="list-unstyled small">
                        <li><code>VPS_HOST</code> - Your VPS IP or hostname</li>
                        <li><code>VPS_USER</code> - SSH username (default: root)</li>
                        <li><code>VPS_PASSWORD</code> - SSH password</li>
                        <li><code>VPS_SSH_KEY</code> - SSH private key (alternative to password)</li>
                        <li><code>VPS_PORT</code> - SSH port (default: 22)</li>
                        <li><code>ADMIN_PASSWORD</code> - Admin panel password</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle auth method fields
    document.querySelectorAll('input[name="authMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('passwordField').classList.toggle('d-none', this.value === 'key');
            document.getElementById('keyField').classList.toggle('d-none', this.value === 'password');
        });
    });
    
    // Load current connection status
    checkConnectionStatus();
});

async function checkConnectionStatus() {
    try {
        const response = await fetch('/api/vps/status');
        const data = await response.json();
        
        const statusDiv = document.getElementById('connectionStatus');
        if (data.connected) {
            statusDiv.className = 'alert alert-success mb-3';
            statusDiv.innerHTML = `<i class="bi bi-check-circle me-2"></i>Connected to ${data.host}`;
            
            // Load VPS info
            loadVpsInfo();
        } else {
            statusDiv.className = 'alert alert-warning mb-3';
            statusDiv.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Not connected to VPS';
        }
        
        // Populate form with env values if available
        if (data.host) document.getElementById('vpsHost').value = data.host;
        if (data.user) document.getElementById('vpsUser').value = data.user;
        if (data.port) document.getElementById('vpsPort').value = data.port;
    } catch (error) {
        console.error('Error checking status:', error);
    }
}

async function loadVpsInfo() {
    try {
        const response = await fetch('/api/system/stats');
        const data = await response.json();
        
        if (data.success) {
            const stats = data.stats;
            document.getElementById('vpsInfo').innerHTML = `
                <table class="table table-sm">
                    <tr><td>CPU Cores</td><td><strong>${stats.cpu.count}</strong></td></tr>
                    <tr><td>CPU Usage</td><td><strong>${stats.cpu.percent.toFixed(1)}%</strong></td></tr>
                    <tr><td>Memory</td><td><strong>${formatBytes(stats.memory.used)} / ${formatBytes(stats.memory.total)}</strong></td></tr>
                    <tr><td>Disk</td><td><strong>${formatBytes(stats.disk.used)} / ${formatBytes(stats.disk.total)}</strong></td></tr>
                    <tr><td>Uptime</td><td><strong>${stats.uptime}</strong></td></tr>
                    <tr><td>Processes</td><td><strong>${stats.process_count}</strong></td></tr>
                </table>
            `;
        }
    } catch (error) {
        console.error('Error loading VPS info:', error);
    }
}

async function testConnection() {
    const host = document.getElementById('vpsHost').value;
    const user = document.getElementById('vpsUser').value;
    const port = document.getElementById('vpsPort').value;
    const authMethod = document.querySelector('input[name="authMethod"]:checked').value;
    const password = authMethod === 'password' ? document.getElementById('vpsPassword').value : '';
    const sshKey = authMethod === 'key' ? document.getElementById('vpsSshKey').value : '';
    
    const statusDiv = document.getElementById('connectionStatus');
    statusDiv.className = 'alert alert-info mb-3';
    statusDiv.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Testing connection...';
    
    try {
        const response = await fetch('/api/vps/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ host, user, port, password, ssh_key: sshKey })
        });
        const data = await response.json();
        
        if (data.success) {
            statusDiv.className = 'alert alert-success mb-3';
            statusDiv.innerHTML = `<i class="bi bi-check-circle me-2"></i>Connection successful!`;
        } else {
            statusDiv.className = 'alert alert-danger mb-3';
            statusDiv.innerHTML = `<i class="bi bi-x-circle me-2"></i>Connection failed: ${data.error}`;
        }
    } catch (error) {
        statusDiv.className = 'alert alert-danger mb-3';
        statusDiv.innerHTML = `<i class="bi bi-x-circle me-2"></i>Error: ${error.message}`;
    }
}

async function saveAndConnect() {
    const host = document.getElementById('vpsHost').value;
    const user = document.getElementById('vpsUser').value;
    const port = document.getElementById('vpsPort').value;
    const authMethod = document.querySelector('input[name="authMethod"]:checked').value;
    const password = authMethod === 'password' ? document.getElementById('vpsPassword').value : '';
    const sshKey = authMethod === 'key' ? document.getElementById('vpsSshKey').value : '';
    
    const statusDiv = document.getElementById('connectionStatus');
    statusDiv.className = 'alert alert-info mb-3';
    statusDiv.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Connecting...';
    
    try {
        const response = await fetch('/api/vps/connect', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ host, user, port, password, ssh_key: sshKey })
        });
        const data = await response.json();
        
        if (data.success) {
            statusDiv.className = 'alert alert-success mb-3';
            statusDiv.innerHTML = `<i class="bi bi-check-circle me-2"></i>Connected to ${host}!`;
            loadVpsInfo();
        } else {
            statusDiv.className = 'alert alert-danger mb-3';
            statusDiv.innerHTML = `<i class="bi bi-x-circle me-2"></i>Connection failed: ${data.error}`;
        }
    } catch (error) {
        statusDiv.className = 'alert alert-danger mb-3';
        statusDiv.innerHTML = `<i class="bi bi-x-circle me-2"></i>Error: ${error.message}`;
    }
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}
</script>
{% endblock %}
