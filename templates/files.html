{% extends "base.html" %}

{% block title %}File Browser - VPS Manager{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-folder me-2"></i>File Browser</h2>

<div class="card mb-3">
    <div class="card-header">
        <div class="d-flex align-items-center flex-wrap gap-2">
            <div class="btn-group me-2">
                <button class="btn btn-sm btn-outline-secondary" onclick="goUp()" title="Go Up">
                    <i class="bi bi-arrow-up"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="goHome()" title="Go Home (~)">
                    <i class="bi bi-house"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="navigateTo('/')" title="Go to Root (/)">
                    <i class="bi bi-hdd"></i>
                </button>
            </div>
            <div class="btn-group me-2">
                <button class="btn btn-sm btn-outline-info" onclick="navigateTo('/home/ubuntu')" title="Ubuntu Home">
                    <i class="bi bi-house-door"></i> Ubuntu
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="navigateTo('/root')" title="Root Home">
                    <i class="bi bi-person"></i> Root
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="navigateTo('/var/log')" title="Logs">
                    <i class="bi bi-file-text"></i> Logs
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="navigateTo('/tmp')" title="Temp">
                    <i class="bi bi-folder"></i> /tmp
                </button>
            </div>
            <div class="flex-grow-1 d-flex">
                <input type="text" class="form-control form-control-sm" id="currentPath" 
                       onkeypress="if(event.key==='Enter') navigateTo(this.value)" placeholder="Enter path...">
                <button class="btn btn-sm btn-outline-primary ms-2" onclick="navigateTo(document.getElementById('currentPath').value)" title="Navigate">
                    <i class="bi bi-arrow-right"></i> Go
                </button>
            </div>
            <button class="btn btn-sm btn-outline-secondary" onclick="loadDirectory(currentDir)" title="Refresh">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Size</th>
                        <th>Modified</th>
                        <th>Permissions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="fileList">
                    <tr><td colspan="5" class="text-center">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- View/Edit File Modal -->
<div class="modal fade" id="fileModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileModalTitle">View File</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control font-monospace" id="fileContent" 
                          rows="20" style="font-size: 0.9rem;"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveFile()">
                    <i class="bi bi-save me-1"></i>Save
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentDir = '';
    let parentDir = '';
    let editingFile = null;

    async function loadDirectory(path) {
        const data = await api('/api/files/list', {
            method: 'POST',
            body: JSON.stringify({ path: path || '~' })
        });
        
        if (data.success) {
            currentDir = data.path;
            parentDir = data.parent;
            document.getElementById('currentPath').value = currentDir;
            
            const tbody = document.getElementById('fileList');
            if (data.items.length > 0) {
                tbody.innerHTML = data.items.map(item => `
                    <tr>
                        <td>
                            <span class="file-item" onclick="${item.is_dir ? `loadDirectory('${item.path}')` : `viewFile('${item.path}')`}">
                                <i class="bi ${item.is_dir ? 'bi-folder-fill text-warning' : 'bi-file-text'} me-2"></i>
                                ${item.name}
                            </span>
                        </td>
                        <td>${item.is_dir ? '-' : formatBytes(item.size)}</td>
                        <td>${new Date(item.modified).toLocaleString()}</td>
                        <td><code>${item.permissions}</code></td>
                        <td>
                            ${!item.is_dir ? `
                                <button class="btn btn-sm btn-outline-info me-1" onclick="viewFile('${item.path}')" title="View/Edit">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success me-1" onclick="downloadFile('${item.path}')" title="Download">
                                    <i class="bi bi-download"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${item.path}', ${item.is_dir})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Empty directory</td></tr>';
            }
        } else {
            showToast(data.error, 'error');
        }
    }

    function goUp() {
        if (parentDir && parentDir !== currentDir) {
            loadDirectory(parentDir);
        }
    }

    function goHome() {
        loadDirectory('/home/ubuntu');
    }

    function navigateTo(path) {
        loadDirectory(path);
    }

    async function viewFile(path) {
        const data = await api('/api/files/read', {
            method: 'POST',
            body: JSON.stringify({ path })
        });
        
        if (data.success) {
            editingFile = path;
            document.getElementById('fileModalTitle').textContent = path.split('/').pop();
            document.getElementById('fileContent').value = data.content;
            new bootstrap.Modal(document.getElementById('fileModal')).show();
        } else {
            showToast(data.error, 'error');
        }
    }

    async function saveFile() {
        if (!editingFile) return;
        
        const content = document.getElementById('fileContent').value;
        const data = await api('/api/files/write', {
            method: 'POST',
            body: JSON.stringify({ path: editingFile, content })
        });
        
        if (data.success) {
            showToast('File saved successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('fileModal')).hide();
        } else {
            showToast(data.error, 'error');
        }
    }

    async function deleteItem(path, isDir) {
        const type = isDir ? 'directory' : 'file';
        const confirmMsg = isDir 
            ? `Are you sure you want to delete this directory and all its contents?\n\nPath: ${path}`
            : `Are you sure you want to delete this file?\n\nPath: ${path}`;
        
        if (!confirm(confirmMsg)) return;
        
        const data = await api('/api/files/delete', {
            method: 'POST',
            body: JSON.stringify({ path })
        });
        
        if (data.success) {
            showToast(data.message, 'success');
            loadDirectory(currentDir);
        } else {
            showToast(data.error, 'error');
        }
    }
    
    function downloadFile(path) {
        // Create a temporary link and click it to trigger download
        const url = `/api/files/download?path=${encodeURIComponent(path)}`;
        window.location.href = url;
        showToast('Download started...', 'info');
    }

    // Start at /home/ubuntu by default
    loadDirectory('/home/ubuntu');
</script>
{% endblock %}
